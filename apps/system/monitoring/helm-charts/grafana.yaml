apiVersion: helm.sh/v1
kind: HelmRelease
metadata:
  name: grafana
  namespace: monitoring
spec:
  chart:
    repository: https://grafana.github.io/helm-charts
    name: grafana
    version: 9.0.0
  values:
    persistence:
      enabled: true
      type: pvc
      storageClassName: longhorn
      size: 5Gi
    env:
      GF_AUTH_GENERIC_OAUTH_ENABLED: "true"
      GF_AUTH_GENERIC_OAUTH_NAME: Pocket-ID
      GF_AUTH_GENERIC_OAUTH_SCOPES: "openid profile email groups"
      GF_AUTH_GENERIC_OAUTH_AUTH_URL: https://auth.quiet.ooo/authorize
      GF_AUTH_GENERIC_OAUTH_TOKEN_URL: https://auth.quiet.ooo/api/oidc/token
      GF_AUTH_GENERIC_OAUTH_API_URL: https://auth.quiet.ooo/api/oidc/userinfo
      GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH: "contains(groups[*], 'grafana-admin') && 'Admin' || 'Viewer'"
      GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_STRICT: "true"
      GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP: true
      GF_SERVER_ROOT_URL: https://grafana.quiet.ooo
      GF_AUTH_SIGNOUT_REDIRECT_URL: https://grafana.quiet.ooo/login
      GF_AUTH_GENERIC_OAUTH_AUTH_STYLE: InParams
    envValueFrom:
      GF_AUTH_GENERIC_OAUTH_CLIENT_ID:
        secretKeyRef:
          name: pocketid-oauth
          key: client_id
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
        secretKeyRef:
          name: pocketid-oauth
          key: client_secret
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://prometheus-server.monitoring.svc.cluster.local
            access: proxy
            isDefault: true
            editable: false
          - name: Loki
            type: loki
            url: http://loki.monitoring.svc.cluster.local:3100
            access: proxy
            editable: false
            jsonData:
              derivedFields:
                - name: trace_id
                  regex: '"traceID":"([A-Za-z0-9]+)"'
                  datasourceUid: tempo
                  url: "${__value.raw}"
          - uid: tempo
            name: Tempo
            type: tempo
            url: http://tempo.monitoring.svc.cluster.local:3100
            access: proxy
            editable: false
            jsonData:
              httpMethod: GET
              tracesToLogs:
                datasourceUid: Loki
    service:
      type: ClusterIP # Traefik ingress terminates TLS